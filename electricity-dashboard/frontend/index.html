<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Electricity Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light p-4">
    <div class="container bg-white p-4 rounded shadow">
        <div class="d-flex justify-content-between align-items-center mb4">
            <h1>âš¡ Electricity Data Dashboard</h1>
            <select id="yearSelect" class="form-select w-25" onchange="updateDashboard()"></select>
        </div>
        <div class="row mb-4">
            <div class="col-md-6"><canvas id="usageBarChart"></canvas></div>
            <div class="col-md-6"><canvas id="usagePieChart"></canvas></div>
        </div>

        <h3 class="mt-5">Province Breakdown</h3>
        <table class="table table-striped mt-3">
            <thead class="table-dark">
                <tr><th>Province</th><th>Residential (kWh)</th><th>Small Biz (kWh)</th><th>Large Biz (kWh)</th></tr>
            </thead>
        <tbody id="dataTable"></tbody>
        </table>
    </div>

    <script>
        let usageBar, usagePie;

        async function init() {
            const res = await fetch('http://localhost:8000/api/years');
            const years = await res.json();
            const select = document.getElementById('yearSelect');
            years.forEach(y => select.add(new Option(y, y)));
            updateDashboard();
        }
        async function updateDashboard() {
            const year = document.getElementById('yearSelect').value;

            // Fetch Charts Data
            const statRes = await fetch(`http://localhost:8000/api/stats/${year}`);
            const stats = await statRes.json();
            renderCharts(stats.usage);

            // Fetch Table Data
            const tableRes = await fetch(`http://localhost:8000/api/table/${year}`);
            const rows = await tableRes.json();
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = rows.map(r => `<tr><td>${r.province_name}</td><td>${r.residential_kwh.toLocaleString()}</td><td>${r.small_business_kwh.toLocaleString()}</td><td>${r.large_business_kwh.toLocaleString()}</td></tr>`).join('');
        }
        function renderCharts(data) {
            const labels = ['Residential', 'Small Business', 'Medium Business', 'Large Business', 'EV Charging'];
            const values = labels.map(l => data[l] || 0);

            if (usageBar) usageBar.destroy();
            if (usagePie) usagePie.destroy();
            
            usageBar = new Chart(document.getElementById('usageBarChart'),
            {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Usage (kWh)', data:
                values, backgroundColor: '#3498db' }] }
            });

            usagePie = new Chart(document.getElementById('usagePieChart'),
            {
                type: 'pie',
                data: { labels, datasets: [{ data: values,
                backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'] }] }
            });
        }
        init();
    </script>
</body>
</html>